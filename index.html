<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ –±–∞–Ω–Ω–µ—Ä–æ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --brand:#42b883; --line:#e5e7eb; --shadow:0 4px 12px rgba(0,0,0,.08);
      --chip:#f8fafc; --chip-border:#e5e7eb;
    }
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
    .wrap{max-width:980px;margin:18px auto;padding:0 14px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);}
    header{padding:18px 18px 12px;border-bottom:1px solid var(--line)}
    h1{margin:0 0 10px;font-size:28px;line-height:1.2;font-weight:800}
    .contacts{display:flex;flex-wrap:wrap;align-items:center;gap:.5rem;color:var(--muted);font-size:15px}
    .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.28rem .6rem;border:1px solid var(--chip-border);border-radius:999px;background:var(--chip);text-decoration:none;color:#0f172a;transition:transform .15s}
    .chip:active{transform:translateY(1px)}
    .chip .icon{font-size:1rem;line-height:1}
    .body{padding:18px}
    label{display:block;margin:.8rem 0 .35rem;font-weight:600}
    input,select,button,textarea{font:inherit}
    input[type=number],select{width:100%;padding:.7rem .8rem;border:1px solid var(--line);border-radius:10px;background:#fff;box-sizing:border-box}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-12{grid-column:span 12}
    @media(max-width:720px){.col-6,.col-4{grid-column:span 12}}
    .btn{display:inline-block;width:100%;padding:.9rem 1rem;border:0;border-radius:10px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
    .btn.alt{background:#111827}
    .muted{color:var(--muted)}
    .list-item{border:1px solid var(--line);border-radius:12px;padding:12px 12px 10px;margin:10px 0;background:#fff;position:relative}
    .remove{position:absolute;top:10px;right:10px;border:0;background:#e11d48;color:#fff;border-radius:8px;padding:.35rem .55rem;cursor:pointer}
    .total{margin-top:10px;padding-top:10px;border-top:2px solid #111827;text-align:right;font-size:20px}
    .total span{color:var(--brand);font-weight:800}
    .modal{position:fixed;inset:0;background:rgba(16,18,27,.45);display:flex;align-items:flex-start;justify-content:center;padding:22px;z-index:1000}
    .modal .box{background:#fff;border-radius:12px;max-width:680px;width:100%;box-shadow:var(--shadow);padding:16px}
    textarea{width:100%;min-height:260px;resize:vertical;border:1px solid var(--line);border-radius:10px;padding:.8rem}
  </style>
  
  <script src="https://unpkg.com/vue@3.4.31/dist/vue.global.prod.js" defer></script> 
  <script src="./calculation.js" defer></script> 
  <script src="./markdownExporter.js" defer></script> 
  <script src="./app.js" defer></script> 
  </head> 
  
  <script>
  // –ü—É–±–ª–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö —Ñ–∞–π–ª–æ–≤ app.js
  const { createApp, ref, reactive, computed } = Vue;
  window.addEventListener('DOMContentLoaded', () => {
    createApp({
      setup() {
        const prices = ref({ materials: [], grommets:{}, layout:{} });
        const orderItems = ref([]);

        // –§–æ—Ä–º–∞ –±–µ–∑ –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–π, —Å placeholders –≤ HTML
        const form = reactive({
          materialId: '',
          width: null,
          height: null,
          quantity: null,
          grommetOption: 'none',
          layoutOption: 'none'
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –ø—Ä–∞–π—Å–∞
        (async () => {
          try {
            const r = await fetch('./prices.json', { cache: 'no-store' });
            if (r.ok) {
              prices.value = await r.json();
              if (prices.value?.materials?.length) form.materialId = prices.value.materials[0].id;
            }
          } catch(e) { console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–π—Å', e); }
        })();

        const calculatedItems = computed(() => {
          if (!prices.value || orderItems.value.length === 0) return [];
          return orderItems.value.map(item => {
            const result = calculateTotalCost(item, prices.value); // –ø—É–±–ª–∏—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç: –ø–µ—á–∞—Ç—å + –ª—é–≤–µ—Ä—Å—ã + –º–∞–∫–µ—Ç, –±–µ–∑ "—Ä–µ–∑–∞"
            const opts = [];
            if (item.grommetOption === 'corners') {
              opts.push(`–õ—é–≤–µ—Ä—Å—ã - ${prices.value.grommets.corners?.name || '4 –ø–æ —É–≥–ª–∞–º'}`);
            } else if (item.grommetOption === 'perimeter') {
              opts.push(`–õ—é–≤–µ—Ä—Å—ã - ${prices.value.grommets.perimeter?.name || '–ü–æ –ø–µ—Ä–∏–º–µ—Ç—Ä—É'}`);
            } else {
              opts.push('–õ—é–≤–µ—Ä—Å—ã - –ë–µ–∑');
            }
            opts.push(`–ú–∞–∫–µ—Ç - ${item.layoutOption === 'create' ? '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞' : '–°–≤–æ–π'}`);
            const details = {
              ...item,
              materialName: prices.value.materials.find(m => m.id === item.materialId)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
              optionsString: opts.join(', ')
            };
            return { id: item.id, details, result };
          });
        });

        const grandTotal = computed(() =>
          calculatedItems.value.reduce((t, it) => t + it.result.total, 0)
        );

        function addItem() {
          const width = Number(form.width);
          const height = Number(form.height);
          const quantity = Number(form.quantity);
          if (!form.materialId) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª.');
          if (!Number.isFinite(width) || width <= 0) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —à–∏—Ä–∏–Ω—É (–º).');
          if (!Number.isFinite(height) || height <= 0) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –≤—ã—Å–æ—Ç—É (–º).');
          if (!Number.isFinite(quantity) || quantity <= 0) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç).');
          orderItems.value.push({
            materialId: form.materialId, width, height, quantity,
            grommetOption: form.grommetOption, layoutOption: form.layoutOption,
            id: Date.now() + Math.random()
          });
        }
        function removeItem(id){ orderItems.value = orderItems.value.filter(i => i.id !== id); }
        function formatCurrency(n){ return new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0}).format(n||0); }

        const showTextExport = ref(false);
        const markdownText = ref('');
        function openExport(){ markdownText.value = generateMarkdown(calculatedItems.value, grandTotal.value, formatCurrency); showTextExport.value = true; }
        function exportTxt(){
          if (grandTotal.value <= 0) return;
          const BOM = '\uFEFF';
          const now = new Date(); const y=now.getFullYear(); const m=String(now.getMonth()+1).padStart(2,'0');
          const txt = generateMarkdown(calculatedItems.value, grandTotal.value, formatCurrency);
          const file = `raschet_zakaza_${y}-${m}_${Math.round(grandTotal.value)}rub.txt`;
          const blob = new Blob([BOM + txt], {type:'text/plain;charset=utf-8;'});
          const url = URL.createObjectURL(blob); const a=document.createElement('a');
          a.href=url; a.download=file; document.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }
        function copyExport(){
          const text = markdownText.value || '';
          if (navigator.clipboard) navigator.clipboard.writeText(text).then(()=>alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!')).catch(fallback);
          else fallback();
          function fallback(){ const ta=document.createElement('textarea'); ta.value=text; document.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'); }
        }

        return { prices, form, orderItems, calculatedItems, grandTotal,
                 addItem, removeItem, formatCurrency,
                 showTextExport, openExport, exportTxt, markdownText, copyExport };
      }
    }).mount('#app');
  });
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ –±–∞–Ω–Ω–µ—Ä–æ–≤</h1>
        <div class="contacts">
          <span>–ê–ª–µ–∫—Å–µ–π</span>
          <a href="tel:+79140022777" class="chip" aria-label="–ü–æ–∑–≤–æ–Ω–∏—Ç—å">
            <span class="icon">üìû</span><span>8‚Äë914‚Äë00‚Äë22‚Äë777</span>
          </a>
          <a href="https://wa.me/79140022777" class="chip" target="_blank" rel="noopener" aria-label="WhatsApp">
            <span class="icon">üí¨</span><span>WhatsApp</span>
          </a>
          <a href="https://t.me/+79140022777" class="chip" target="_blank" rel="noopener" aria-label="Telegram">
            <span class="icon">‚úàÔ∏è</span><span>Telegram</span>
          </a>
        </div>
      </header>

      <div class="body" id="app">
        <div class="card" style="padding:14px;margin-bottom:14px;">
          <div class="row">
            <div class="col-12">
              <label>–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
              <select v-model="form.materialId">
                <option v-for="m in prices.materials" :key="m.id" :value="m.id">{{ m.name }}</option>
              </select>
            </div>

            <div class="col-4">
              <label>–®–∏—Ä–∏–Ω–∞ (–º)</label>
              <input type="number" v-model.number="form.width" min="0.5" max="3" step="0.5" placeholder="–Ω–∞–ø—Ä., 1.5">
            </div>
            <div class="col-4">
              <label>–í—ã—Å–æ—Ç–∞ (–º)</label>
              <input type="number" v-model.number="form.height" min="0.5" max="30" step="0.5" placeholder="–Ω–∞–ø—Ä., 2">
            </div>
            <div class="col-4">
              <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç)</label>
              <input type="number" v-model.number="form.quantity" min="1" step="1" placeholder="1">
            </div>

            <div class="col-6">
              <label>–õ—é–≤–µ—Ä—Å—ã</label>
              <select v-model="form.grommetOption">
                <option value="none">–ë–µ–∑ –ª—é–≤–µ—Ä—Å–æ–≤</option>
                <option value="corners">4 –ø–æ —É–≥–ª–∞–º</option>
                <option value="perimeter">–ü–æ –ø–µ—Ä–∏–º–µ—Ç—Ä—É</option>
              </select>
            </div>

            <div class="col-6">
              <label>–ú–∞–∫–µ—Ç</label>
              <select v-model="form.layoutOption">
                <option value="none">–°–≤–æ–π –º–∞–∫–µ—Ç</option>
                <option value="create">–ù—É–∂–Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –º–∞–∫–µ—Ç–∞</option>
              </select>
            </div>

            <div class="col-12" style="margin-top:6px">
              <button class="btn" @click="addItem">–î–æ–±–∞–≤–∏—Ç—å –≤ —Ä–∞—Å—á—ë—Ç</button>
            </div>
          </div>
        </div>

        <div v-if="!prices.materials?.length" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–∞‚Ä¶</div>

        <div v-if="calculatedItems.length === 0" class="muted">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–∑–∏—Ü–∏–∏.</div>

        <div v-else>
          <div class="list-item" v-for="(item, index) in calculatedItems" :key="item.id">
            <div style="font-weight:700;margin-bottom:.25rem">#{{ index + 1 }}</div>
            <div><strong>–ú–∞—Ç–µ—Ä–∏–∞–ª:</strong> {{ item.details.materialName }}</div>
            <div><strong>–†–∞–∑–º–µ—Ä:</strong> {{ item.details.width }} –º x {{ item.details.height }} –º ({{ item.details.quantity }} —à—Ç.)</div>
            <div><strong>–û–ø—Ü–∏–∏:</strong> {{ item.details.optionsString }}</div>
            <div style="margin-top:.25rem"><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏: {{ formatCurrency(item.result.total) }}</strong></div>
            <button class="remove" @click="removeItem(item.id)">–£–¥–∞–ª–∏—Ç—å</button>
          </div>

          <div class="total"><strong>–ò—Ç–æ–≥–æ:</strong> <span>{{ formatCurrency(grandTotal) }}</span></div>

          <div class="row" style="margin-top:10px">
            <div class="col-6"><button class="btn alt" @click="openExport">–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å—á—ë—Ç</button></div>
            <div class="col-6"><button class="btn" @click="exportTxt">–°–∫–∞—á–∞—Ç—å —Ä–∞—Å—á—ë—Ç (txt)</button></div>
          </div>
        </div>

        <div v-if="showTextExport" class="modal" @click.self="showTextExport=false">
          <div class="box">
            <h2 style="margin:0 0 8px">–ì–æ—Ç–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç</h2>
            <textarea readonly>{{ markdownText }}</textarea>
            <div class="row" style="margin-top:10px">
              <div class="col-6"><button class="btn alt" @click="showTextExport=false">–ó–∞–∫—Ä—ã—Ç—å</button></div>
              <div class="col-6"><button class="btn" @click="copyExport">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</body>
</html>
